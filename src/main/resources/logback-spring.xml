<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- Spring Property로 application.yml의 설정 읽기 -->
    <springProperty scope="context" name="LOG_PATH" source="logging.file.path" defaultValue="./logs"/>
    <springProperty scope="context" name="ROOT_LOG_LEVEL" source="logging.level.root" defaultValue="INFO"/>
    <springProperty scope="context" name="VIBE_SCON_LOG_LEVEL" source="logging.level.vibe.scon" defaultValue="DEBUG"/>
    
    <!-- 로그 파일 이름 -->
    <property name="LOG_FILE_NAME" value="application"/>
    <property name="API_LOG_FILE_NAME" value="api-requests"/>

    <!-- 콘솔 출력 패턴 -->
    <property name="CONSOLE_LOG_PATTERN" 
              value="[%X{requestId:-}] %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"/>

    <!-- 파일 출력 패턴 -->
    <property name="FILE_LOG_PATTERN" 
              value="[%X{requestId:-}] %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"/>

    <!-- 콘솔 Appender -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 일반 애플리케이션 로그 파일 Appender -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE_NAME}.log</file>
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- 매일 자정에 파일 분리: application.2024-01-06.log 형식 -->
            <fileNamePattern>${LOG_PATH}/${LOG_FILE_NAME}.%d{yyyy-MM-dd}.log</fileNamePattern>
            <!-- 로그 보관 기간: 30일 -->
            <maxHistory>30</maxHistory>
            <!-- 전체 로그 폴더 크기 제한: 1GB -->
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- API 요청/응답 로그 파일 Appender -->
    <appender name="API_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${API_LOG_FILE_NAME}.log</file>
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${API_LOG_FILE_NAME}-%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>500MB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- ApiLogger 클래스의 로그는 API_FILE로 전송 -->
    <logger name="vibe.scon.scon_backend.util.ApiLogger" level="INFO" additivity="false">
        <appender-ref ref="API_FILE"/>
        <!-- 개발 환경에서만 콘솔 출력 -->
        <springProfile name="dev,local">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- 환경별 루트 로거 설정 -->
    <springProfile name="dev,local">
        <root level="${ROOT_LOG_LEVEL}">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
        
        <!-- vibe.scon 패키지 로깅 레벨 -->
        <logger name="vibe.scon" level="${VIBE_SCON_LOG_LEVEL}"/>
        
        <!-- Hibernate SQL 로깅 (개발 환경) -->
        <logger name="org.hibernate.SQL" level="DEBUG"/>
        <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>
        <logger name="org.springframework.web" level="DEBUG"/>
    </springProfile>

    <springProfile name="prod">
        <root level="WARN">
            <appender-ref ref="FILE"/>
        </root>
        
        <logger name="vibe.scon" level="INFO"/>
        <logger name="org.hibernate.SQL" level="WARN"/>
    </springProfile>
</configuration>
